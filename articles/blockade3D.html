<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
	<meta charset="UTF-8">
	<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
	<title>БЛОКАДА 3D СЕРВЕР</title>
	<link rel="stylesheet" href="../style.css">
	<link rel="stylesheet" href="../article_styles.css">
</head>
	<header>
		<h1>Заметки Баебобо</h1>
	</header>
<body>
<a href="../index.html" class="back-button"><<<</a>
	
<p style="text-align: center;"><strong>О работе и структуре игрового сервера браузерной онлайн-игры Блокада 3D</strong></p>
<p style="text-align: center;"><strong>by Baebobo</strong></p>
<p><br></p>
<p>Типа дисклеймер:</p>
<p>Это не является гайдом или&nbsp;официальной&nbsp;документацией для создания собственного игрового сервера&nbsp;для Блокада 3D, а лишь наблюдениями и исследованиями&nbsp;случайного чела из интернета.&nbsp;Используйте эту информацию на свой страх и риск.&nbsp;Предполагается что вы знайте как&nbsp;декомпилировать исходный код&nbsp;и&nbsp;имейте представление о&nbsp;разработки мультиплеерных игр.&nbsp;Эти&nbsp;исследования&nbsp;были использованы при создании проекта RESQUAD.</p>
<p><br></p>
<p style="text-align: center;"><strong>Ознакомление.</strong></p>
<p>Фанаты&nbsp;многих&nbsp;ныне&nbsp;&laquo;мёртвых&raquo;&nbsp;онлайн игр пытаются нередко вернуть их к жизни путём реконструкции серверной части&nbsp;или даже&nbsp;восстановления исходников игры.</p>
<p>Примерами может послужить множество старых ММО игр,&nbsp;такие как Lineage, World of&nbsp;Warcraft,&nbsp;Ultima Online,&nbsp;Club Penguin&nbsp;и другие.</p>
<p>Не все из них конечно же мертвы, но&nbsp;фанаты могут захотеть&nbsp;создавать свои онлайн сервера, со своими правилами, например, если считают что они могут дать более лучший игровой опыт, чем&nbsp;сами&nbsp;разработчики, причин масса.&nbsp;Однако часто разработчики не предоставляют исходный код к серверам&nbsp;своих&nbsp;игр, по очевидным причинам. Здесь вступает сила, хакеров, программистов и просто людей, которым интересно изучать то как работает или работала их любимая игра.</p>
<p><br></p>
<p>В&nbsp;данном документе&nbsp;я рассмотрю основную структуру конкретно&nbsp;<strong>игрового</strong> сервера&nbsp;стим версии&nbsp;от&nbsp;<strong>2014 года,&nbsp;</strong>однако&nbsp;эти методы применимы и к современной версии :)&nbsp;Поскольку игра использует так же веб-сервер для авторизации&nbsp;игроков&nbsp;и&nbsp;списка&nbsp;игровых&nbsp;серверов, он&nbsp;рассматриваться не будет.&nbsp;В игре есть множество игровых режимов и микро моментов которые я затрону&nbsp;лишь немного.</p>
<p><strong>Термины.</strong></p>
<ul>
    <li>
        <p>Клиент&nbsp;игры/Билд&nbsp;&mdash;&nbsp;Непосредственно сама игра.</p>
    </li>
    <li>
        <p>Буфер записи&nbsp;(sendBuffer)&nbsp;&mdash; байтовый массив размером 1024, используется клиентом игры&nbsp;чтобы записывать данные для отправки, например&nbsp;запросить у сервера поменять оружие.</p>
        <p><br></p>
    </li>
    <li>
        <p>Буфер чтения&nbsp;(readBuffer)&nbsp;&mdash; байтовый массив, используется клиентом игры для&nbsp;чтения данных с сервера, используется для</p>
    </li>
    <li>
        <p>Клиент &mdash; по сути&nbsp;тоже что и игрок, оба слова будут использоваться.</p>
    </li>
</ul>
<p><br></p>
<p style="text-align: center;"><strong>Методы исследования.</strong></p>
<p>Есть разные способы изучить то как работает сетевой код в играх.&nbsp;Например&nbsp;инструменты&nbsp;декомпиляции и просмотра исходного кода C# - IlSpy, DnSpy.&nbsp;Вероятно это самый действенный способ для игр на Unity, поскольку в большинстве случаев вы получите код очень близкий к оригинальному.</p>
<p>Однако так вы не сможете узнать как работает сервер, по этому здесь приходится&nbsp;методом проб и ошибок&nbsp;повторить логику сервера.</p>
<p><em>P.S. Сетевой код&nbsp;клиента&nbsp;находится в скрипте Client.cs</em></p>
<p><br></p>
<p><br></p>
<p><br></p>
<p style="text-align: center;"><strong>Основы основ.</strong></p>
<p>Прежде чем начать что-то делать, нужно разобраться с тем как и какие входные и выходные данные&nbsp;клиент&nbsp;Блокада 3D&nbsp;ожидает. Для подключения к серверу клиент использует TCP протокол,&nbsp;это позволяет гарантировать что &laquo;сегменты&raquo; были доставлены&nbsp;в правильном порядке.&nbsp;Общение между сервером и клиентом&nbsp;работает&nbsp;по следующей схеме:</p>
<p><br></p>
<p><strong>1.&nbsp;Клиент отправляет&nbsp;ИЛИ запрашивает данные</strong></p>
<p>&darr;</p>
<p><strong>2.&nbsp;Сервер обрабатывает данные</strong></p>
<p>&darr;</p>
<p><strong>3.&nbsp;</strong><strong>С</strong><strong>ервер отправляет&nbsp;</strong><strong>обработанные данные</strong><strong>&nbsp;всем клиентам&nbsp;</strong><strong>ИЛИ</strong><strong>&nbsp;одному клиенту</strong></p>
<p><br></p>
<p>Так будет работать общение клиента и сервера на протяжении всего боя.&nbsp;При правильной реализации, такая схема позволит предотвратить множество хаков и читов.</p>
<p><br></p>
<p><br></p>
<p style="text-align: center;"><strong>Структура данных.</strong></p>
<p><em>На самом деле создать сервер для игры не так уж и сложно, сложнее создать его качественным.&nbsp;</em></p>
<p>Предположим что мы изменили клиент игры под себя, чтобы он мог подключаться к стороннему IP адресу и сделали простой&nbsp;&laquo;TCP Listener&raquo;&nbsp;, что дальше?&nbsp;Здесь&nbsp;начинается&nbsp;самая важная часть &mdash; формат&nbsp;пакетов.&nbsp;Пакетами&nbsp;я буду называть отправленные&nbsp;массивы unsigned байтов&nbsp;между клиентом и сервером.</p>
<p>Рассмотрим как обычно выглядят сообщения игры:</p>
<p>Игрок хочет&nbsp;играть за красную команду,&nbsp;он отправляет следующие байты&nbsp;на сервер.</p>
<p>245;&nbsp;9; 0; 0; 1; 0; 3</p>
<p><br></p>
<p>Первый байт&nbsp;<strong>всегда</strong> magic&nbsp;значение&nbsp;<strong>245</strong>!&nbsp;Каждый пакет&nbsp;должнен&nbsp;содержать этот байт, иначе клиент будет отклонять&nbsp;его.</p>
<p><br></p>
<p>Второй байт &mdash;&nbsp;тип&nbsp;пакета. С помощью этого байта клиент или сервер определяет для чего этот&nbsp;пакет предназначен. В данном случае&nbsp;значение&nbsp;9 &mdash; это запрос серверу&nbsp;на смену команды игрока.&nbsp;Так же обязательный байт.</p>
<p><br></p>
<p>Третий и четвёртый байт обычно не выполняют никакой функции, но иногда могут использоваться.&nbsp;</p>
<p><br></p>
<p>Пятый байт &mdash; айди&nbsp;команды, в данном случае игрок выбирает играть за красных.</p>
<p><br></p>
<p>Шестой байт &mdash; класс оружия.</p>
<p><br></p>
<p>Седьмой байт &mdash; айди оружия.</p>
<p><br></p>
<p><em>В Client.cs это&nbsp;</em><em>функция</em><em>&nbsp;&laquo;send_jointeamclass&raquo;</em></p>
<p><br></p>
<p>Далее команды будут рассматриваться в виде таблицы для упрощения.</p>
<p>Стоит учесть во внимание что некоторые сообщения используют несколько байт для хранения других типов данных, такие как Int32,&nbsp;Long,&nbsp;Short, String и т.д.</p>
<p><br></p>
<p>Такие данные получает сервер,&nbsp;что с ними делать? Конечно же обработать и отправить результат, но здесь есть&nbsp;важные&nbsp;нюансы.</p>
<p><br></p>
<p>Не смотря на то, что сервер должен отправлять&nbsp;пакеты&nbsp;в таком же формате, есть определённые детали, которые можно не заметить. Первое что нужно понять &mdash; отправлять результат всем клиентам или только&nbsp;одному, или вообще выбрать несколько конкретных?&nbsp;Здесь зависит от контекста:</p>
<ul>
    <li>
        <p>Если&nbsp;если вы авторизуйте игрока, о чём будет ниже, вы должны отправлять данные только&nbsp;этому&nbsp;игроку.</p>
    </li>
</ul>
<p><br></p>
<ul>
    <li>
        <p>Если игрок отправляет текущую позицию, то нужно&nbsp;отправить&nbsp;её&nbsp;всем игрокам.</p>
    </li>
</ul>
<p><br></p>
<ul>
    <li>
        <p>Если&nbsp;же игрок отправляет сообщение в командный чат, то нужно отправить игрокам только в той же команде что и отправляющий.</p>
    </li>
</ul>
<p>Но что ещё более важно, тип отправленного клиентом&nbsp;пакета&nbsp;не всегда совпадает с тем, который&nbsp;отправляет сервер. Нужно усердно изучать игру, чтобы понять какие&nbsp;пакеты для чего нужны.</p>
<p><br></p>
<p><em>В Client.cs есть два типа функций. &laquo;send_&raquo; используется для отправки на сервер, а &laquo;recv_&raquo; для получения данных с сервера.</em></p>
<p style="text-align: center;"><strong>Авторизация&nbsp;</strong><strong>клиента</strong><strong>.</strong></p>
<p><em>В современной версии несколько более усложнённая авторизация, но в&nbsp;</em><em>версии&nbsp;</em><em>2014&nbsp;</em><em>года</em><em>&nbsp;она достаточно простая и для примера будет создана заглушк</em><em>а.</em></p>
<p><br></p>
<p>Как только клиент подключается к серверу, он попадает на&nbsp;загрузочный экран.</p>
<p>В этот момент&nbsp;он&nbsp;отправляет на сервер своё первое сообщение с запросом на авторизацию.</p>
<p>Клиент посылает следующие данные:</p>
<p>send_auth</p>
<p><br></p>
<table cellpadding="5" cellspacing="0">
    <tbody>
        <tr>
            <td>
                <p>ТИП - ЗНАЧЕНИЕ</p>
            </td>
            <td>
                <p>ОПИСАНИЕ</p>
            </td>
        </tr>
        <tr>
            <td>
                <p>Byte &ndash; 245</p>
            </td>
            <td>
                <p>magic</p>
            </td>
        </tr>
        <tr>
            <td>
                <p>Byte &ndash; 0</p>
            </td>
            <td>
                <p>Тип сообщения, 0 - авторизоваться</p>
            </td>
        </tr>
        <tr>
            <td>
                <p>Byte &ndash; 0</p>
            </td>
            <td>
                <p><br></p>
            </td>
        </tr>
        <tr>
            <td>
                <p>Byte &ndash; 0</p>
            </td>
            <td>
                <p><br></p>
            </td>
        </tr>
        <tr>
            <td>
                <p>Byte &ndash; 1</p>
            </td>
            <td>
                <p>Номер страны в которой клиент проживает</p>
            </td>
        </tr>
        <tr>
            <td>
                <p>Long &ndash; 0</p>
            </td>
            <td>
                <p>Пароль, нужно только для входа на приватные сервера</p>
            </td>
        </tr>
        <tr>
            <td>
                <p>String &ndash; &laquo;123456789&raquo;</p>
            </td>
            <td>
                <p>Айди аккаунта игрока, обычно для&nbsp;Steam/VK/OK/FB</p>
            </td>
        </tr>
        <tr>
            <td>
                <p>String &ndash; &laquo;0&raquo;</p>
            </td>
            <td>
                <p>Эта строка всегда имеет значение &laquo;0&raquo;</p>
            </td>
        </tr>
        <tr>
            <td>
                <p>String &ndash; &laquo;0&raquo;</p>
            </td>
            <td>
                <p>Эта строка всегда имеет значение &laquo;0&raquo;</p>
            </td>
        </tr>
        <tr>
            <td>
                <p>String &ndash; &laquo;Camper1337&raquo;</p>
            </td>
            <td>
                <p>Никнейм клиента/игрока</p>
            </td>
        </tr>
    </tbody>
</table>
<p><br></p>
<p>Сервер должен обработать правильно эти данные, например записать нового клиента в список, в котором хранится информация о всех клиентах на сервере (Их текущая позиция,&nbsp;команда,&nbsp;выбранное оружие, здоровье и т.д.)</p>
<p><br></p>
<p>После получения запроса на авторизацию сервер принимает решение и в случае успеха возвращает следующие данные&nbsp;клиенту,&nbsp;который запрашивал авторизацию.</p>
<p>recv_auth</p>
<table cellpadding="5" cellspacing="0">
    <tbody>
        <tr>
            <td>
                <p>ТИП - ЗНАЧЕНИЕ</p>
            </td>
            <td>
                <p>ОПИСАНИЕ</p>
            </td>
        </tr>
        <tr>
            <td>
                <p>0.00%</p>
            </td>
            <td>
                <p>magic</p>
            </td>
        </tr>
        <tr>
            <td>
                <p>Byte &ndash; 0</p>
            </td>
            <td>
                <p>Тип сообщения, 0 - авторизоваться</p>
            </td>
        </tr>
        <tr>
            <td>
                <p>Byte &ndash; 0</p>
            </td>
            <td>
                <p><br></p>
            </td>
        </tr>
        <tr>
            <td>
                <p>Byte &ndash; 0</p>
            </td>
            <td>
                <p><br></p>
            </td>
        </tr>
        <tr>
            <td>
                <p>Byte &ndash; 0</p>
            </td>
            <td>
                <p>Режим игры, в данном случае режим &laquo;Битва&raquo;</p>
            </td>
        </tr>
        <tr>
            <td>
                <p>Int &ndash; 7</p>
            </td>
            <td>
                <p>Длина названия карты</p>
            </td>
        </tr>
        <tr>
            <td>
                <p>String &ndash; Citadel</p>
            </td>
            <td>
                <p>Название карты</p>
            </td>
        </tr>
    </tbody>
</table>
<p><br></p>
<p>Если данные клиент получил успешно, то в клиенте игры можно будет увидеть как загрузка продвинулась на один сегмент.</p>
<p><br></p>
<p style="text-align: center;"><strong>Загрузка карт.</strong></p>
<p>Однако дальше идёт довольно&nbsp;сложный&nbsp;момент &mdash;&nbsp;в игре есть много&nbsp;игровых карт. Каждая карта&nbsp;в Блокаде - это трёхмерная воксельная сетка размером 256x64x256, на каждый&nbsp;воксель&nbsp;приходится по одному байту, который отвечает за его ID.</p>
<p>Например&nbsp;0&nbsp;&mdash; это воздух, а 1 &mdash; камень.</p>
<p>И для того чтобы завершить авторизацию игрок должен загрузить эту карту с сервера. Я любезно предоставляю рипы некоторых карт из Блокады.&nbsp;Часть из них были вручную конвертированы в более простой формат и пофикшены.</p>
<a href="./0 class="read-more">Скачать архивом</a>
<p><br></p>
<p>Загрузка карты разделяется на&nbsp;три&nbsp;этапа:</p>
<p>1.&nbsp;Сервер после авторизации должен&nbsp;отправить&nbsp;несколько сообщений с данными карты.&nbsp;(Каждое сообщение &mdash; это сжатые&nbsp;GZIP&nbsp;данные для&nbsp;каждого&nbsp;чанка,&nbsp;размер чанка&nbsp;16x16x16)recv_chunk</p>
<p>2.&nbsp;Сервер отправляет данные со спавнами всех команд (8 спавнеров на 4 команды)&nbsp;recv_mapdata&nbsp;</p>
<p>3.&nbsp;Сервер подтверждает&nbsp;что карта была полностью отправлена.&nbsp;recv_chunk_finish</p>
<p><br></p>
<p>Если 3 пункта были выполнены верно, то карта загрузится и мы появимся высоко в небе, без возможности двигаться.</p>
<p><br></p>
<p><em>Статься в процессе...</em></p>
	
	<footer>
			<p>Вся информация здесь личное мнение автора</p>
	</footer>
<script src="../gfx.js"></script>
<script src="../p5.js"></script>
</body>

</html>
